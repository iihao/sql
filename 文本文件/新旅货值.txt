SELECT 
  newid() as guid, 
  GETDATE() as date, 
  wd, 
  ProjGUID, 
  [BldGUID], 
  公司, 
  项目名称, 
  分期名称, 
  大业态, 
  小业态, 
  楼栋名称, 
  房间户型, 
  销许日期, 
  计划套数, 
  计划面积, 
  计划均价, 
  计划货值, 
  动态套数, 
  动态面积, 
  动态均价, 
  动态货值, 
  已取证套数, 
  已取证面积, 
  已取证均价, 
  已取证货值, 
  签约套数, 
  签约面积, 
  签约均价, 
  签约货值, 
  认购未签套数, 
  认购未签面积, 
  认购未签货值, 
  已推未售套数, 
  已推未售面积, 
  已推未售货值, 
  取证未推售套数, 
  取证未推售面积, 
  取证未推售货值, 
  未取证未推售套数, 
  未取证未推售面积, 
  未取证未推售货值 
FROM 
  (
	SELECT 
	  1 AS wd, 
	  [ProjGUID], 
	  [BldGUID], 
	  r.公司, 
	  r.项目名称, 
	  分期名称, 
	  大业态, 
	  小业态, 
	  楼栋名称, 
	  房间户型, 
	  销许日期, 
	  计划套数, 
	  CASE WHEN ISNULL(底价金额, 0) = 0 THEN 楼栋可售面积 / dex ELSE 计划面积 END AS 计划面积, 
	  CASE WHEN ISNULL(计划货值, 0) = 0 
	  OR ISNULL(底价金额, 0) = 0 THEN 目标单价 ELSE CASE WHEN 大业态 = '车库/库房' THEN 计划货值 / 计划套数 ELSE 计划货值 / 计划面积 END * 10000 END AS 计划均价, 
	  CASE WHEN ISNULL(计划货值, 0) = 0 
	  OR ISNULL(底价金额, 0) = 0 THEN 楼栋可售金额 / dex ELSE 计划货值 END AS 计划货值, 
	  动态套数, 
	  CASE WHEN ISNULL(底价金额, 0) = 0 THEN 楼栋可售面积 / dex ELSE 动态面积 END AS 动态面积, 
	  CASE WHEN ISNULL(计划货值, 0) = 0 
	  OR ISNULL(底价金额, 0) = 0 THEN 目标单价 ELSE CASE WHEN 大业态 = '车库/库房' THEN 动态货值 / 动态套数 ELSE 动态货值 / 动态面积 END * 10000 END AS 动态均价, 
	  CASE WHEN ISNULL(动态货值, 0) = 0 
	  OR ISNULL(底价金额, 0) = 0 THEN 楼栋可售金额 / dex ELSE 动态货值 END AS 动态货值, 
	  已取证套数, 
	  已取证面积, 
	  case when isnull(已取证套数, 0)= 0 or isnull(已取证面积, 0)= 0 then 0 else (
		已取证货值 /(
		  case when 大业态 = '车库/库房' THEN 已取证套数 else 已取证面积 end
		)* 10000
	  ) end AS 已取证均价, 
	  已取证货值, 
	  签约套数, 
	  签约面积, 
	  case when isnull(签约套数, 0)= 0 or isnull(签约面积, 0)= 0 then 0 else (
		签约货值 /(
		  case when 大业态 = '车库/库房' THEN 签约套数 else 签约面积 end
		)* 10000
	  ) end AS 签约均价, 
	  签约货值, 
	  认购未签套数, 
	  认购未签面积, 
	  认购未签货值, 
	  已推未售套数, 
	  已推未售面积, 
	  已推未售货值, 
	  取证未推售套数, 
	  取证未推售面积, 
	  取证未推售货值, 
	  未取证未推售套数,
	 --  未取证未推售面积, 
	 CASE WHEN ISNULL(未取证未推售面积, 0) = 0  and  isnull(销许日期,'')=''
	   THEN 楼栋可售面积 / dex ELSE 未取证未推售面积 END AS 未取证未推售面积,
		CASE WHEN ISNULL(未取证未推售货值, 0) = 0  and  isnull(销许日期,'')=''
	   THEN 楼栋可售金额 / dex ELSE 未取证未推售货值 END AS 未取证未推售货值
	FROM 
	  (
		SELECT 
		  mu.BUName AS 公司, 
		  p1.ProjName AS 项目名称, 
		  p.ProjShortName AS 分期名称, 
		  p.p_projectId AS ProjGUID, 
		  sb.BldGUID AS BldGUID, 
		  pmpt.ParentName AS 大业态, 
		  pmpt.Name AS 小业态, 
		  sb.BldName AS 楼栋名称, 
		  sr.HxName AS 房间户型, 
		  bp.FactEndDate AS 销许日期, 
		  SUM(1) OVER (
			PARTITION BY mu.BUName, p.p_projectId, 
			sb.BldGUID, p1.ProjName, p.ProjShortName, 
			pmpt.ParentName, pmpt.Name, sb.BldName
		  ) AS dex, 
		  AVG(
		  case when mb.IsParkingSpace=1 then
		  mb.TargetUnitPrice*(isnull(mb.UpCarNum,0)+isnull(mb.DownCarNum,0)) else
			mb.TargetUnitPrice * (
			  isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
			) end
		  ) / 10000 AS 楼栋可售金额, 
		  AVG(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) AS 楼栋可售面积, 
		  AVG(mb.TargetUnitPrice) AS 目标单价, 
		  SUM(sr.DjTotal) AS 底价金额, 
		  SUM(
			CASE WHEN isnull(sr.RoomGUID, NULL) IS NOT NULL THEN 1 ELSE 0 END
		  ) AS 计划套数, 
		  CASE WHEN SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) = 0 THEN SUM(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) ELSE SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) END AS 计划面积, 
		  SUM(
			CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END
		  ) / 10000 AS 计划货值, 
		  SUM(
			CASE WHEN isnull(sr.RoomGUID, NULL) IS NOT NULL THEN 1 ELSE 0 END
		  ) AS 动态套数, 
		  CASE WHEN SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) = 0 THEN SUM(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) ELSE SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) END AS 动态面积, 
		  SUM(
			CASE WHEN sr.Status = '签约' and sr.IsAnnexe=0 THEN c.CjRoomTotal 
			WHEN sr.Status = '签约' and sr.IsAnnexe=1 THEN so.CjTotal
			WHEN sr.Status = '认购' and sr.IsAnnexe=0 THEN o.CjRoomTotal 
			WHEN sr.Status = '认购' and sr.IsAnnexe=1 THEN so.CjTotal 
			ELSE CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END END
		  ) / 10000 AS 动态货值, 
		  SUM(
			CASE WHEN isnull(sr.RoomGUID, NULL) IS NOT NULL 
			AND isnull(bp.FactEndDate, '') <> '' THEN 1 ELSE 0 END
		  ) AS 已取证套数, 
		  CASE WHEN isnull(bp.FactEndDate, '') <> '' THEN CASE WHEN SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) = 0 THEN SUM(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) ELSE SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) END ELSE 0 END AS 已取证面积, 
		  CASE WHEN isnull(bp.FactEndDate, '') <> '' THEN SUM(
			CASE WHEN sr.Status = '签约' and sr.IsAnnexe=0 THEN c.CjRoomTotal 
			WHEN sr.Status = '签约' and sr.IsAnnexe=1 THEN so.CjTotal
			WHEN sr.Status = '认购' and sr.IsAnnexe=0 THEN o.CjRoomTotal 
			WHEN sr.Status = '认购' and sr.IsAnnexe=1 THEN so.CjTotal 
			 ELSE CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END END
		  ) / 10000 ELSE 0 END AS 已取证货值, 
		  SUM(
			CASE WHEN sr.Status = '签约' THEN 1 ELSE 0 END
		  ) AS 签约套数, 
		  SUM(
			CASE WHEN sr.Status = '签约' THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 签约面积, 
		  SUM(
			CASE WHEN sr.Status = '签约' and sr.IsAnnexe=0 THEN c.CjRoomTotal
			WHEN sr.Status = '签约' and sr.IsAnnexe=1 THEN so.CjTotal
			 ELSE 0 END
		  ) / 10000 AS 签约货值, 
		  SUM(
			CASE WHEN sr.Status = '认购' THEN 1 ELSE 0 END
		  ) AS 认购未签套数, 
		  SUM(
			CASE WHEN sr.Status = '认购' THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 认购未签面积, 
		  SUM(
			CASE WHEN sr.Status = '认购' and sr.IsAnnexe=0 THEN o.CjRoomTotal 
			WHEN sr.Status = '认购' and sr.IsAnnexe=1 THEN so.CjTotal  ELSE 0 END
		  ) / 10000 AS 认购未签货值, 
		  SUM(
			CASE WHEN sr.Status IN ('待售', '预留', '小订') THEN 1 ELSE 0 END
		  ) AS 已推未售套数, 
		  SUM(
			CASE WHEN sr.Status IN ('待售', '预留', '小订') THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 已推未售面积, 
		  SUM(
			CASE WHEN sr.Status IN ('待售', '预留', '小订') THEN CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END ELSE 0 END
		  ) / 10000 AS 已推未售货值, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') <> '' THEN 1 ELSE 0 END
		  ) AS 取证未推售套数, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') <> '' THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 取证未推售面积, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') <> '' THEN CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END ELSE 0 END
		  ) / 10000 AS 取证未推售货值, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') = '' THEN 1 ELSE 0 END
		  ) AS 未取证未推售套数, 
		  SUM(
			CASE WHEN  isnull(bp.FactEndDate, '') = ''  THEN  sr.BldArea   ELSE 0 END
		  ) AS 未取证未推售面积, 
		  SUM(
			CASE WHEN isnull(bp.FactEndDate, '') = '' THEN CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END ELSE 0 END
		  ) / 10000 AS 未取证未推售货值 
		FROM 
		  mdm_Building mb LEFT JOIN 
		  s_Building sb ON sb.MasterBldGUID = mb.BuildingGUID
		 LEFT JOIN s_Room sr ON sb.BldGUID = sr.BldGUID 
		 INNER JOIN (
			SELECT 
			  BuildingGUID, 
			  FactEndDate 
			FROM 
			  p_Build2PlanNode 
			WHERE 
			  NodeName = '获取预售许可证'
		  ) bp ON bp.BuildingGUID = sb.MasterBldGUID  
		  INNER JOIN p_MasterDataProductType pmpt WITH (NOLOCK) ON pmpt.p_MasterDataProductTypeId = sb.ProductTypeGUID 
		  INNER JOIN (
			SELECT 
			  *, 
			  CASE WHEN isnull(ParentCode, '') = '' THEN ProjCode ELSE ParentCode END AS NewParentCode 
			FROM 
			  p_Project
		  ) p ON sb.ProjGUID = p.p_projectId 
		  LEFT JOIN p_project p1 ON p.NewParentCode = p1.ProjCode 
		  INNER JOIN myBusinessUnit mu WITH (NOLOCK) ON mu.BUGUID = mb.BUGUID 
		  AND mu.IsEndCompany = 1 
		  AND mu.BUType = 1 
		  LEFT JOIN s_contract c WITH (NOLOCK) ON sr.RoomGUID = c.RoomGUID 
		  AND c.status = '激活' 
		  LEFT JOIN s_Order o WITH (NOLOCK) ON sr.RoomGUID = o.RoomGUID 
		  AND o.status = '激活' 
		  LEFT JOIN s_OCAttachRoom so ON so.RoomGUID = sr.RoomGUID 
		  AND so.Status = '激活' 
		  where p.p_projectId in (@projguid) and sb.BldGUID in (@bldguid)
		GROUP BY 
		  mu.BUName, 
		  p.p_projectId, 
		  sb.BldGUID, 
		  p1.ProjName, 
		  p.ProjShortName, 
		  pmpt.ParentName, 
		  pmpt.Name, 
		  sb.BldName, 
		  sr.HxName, 
		  bp.FactEndDate
	  ) r 
	UNION ALL 
	SELECT 
	  2, 
	  NULL, 
	  NULL, 
	  r.公司, 
	  r.项目名称, 
	  '项目业态汇总', 
	  大业态, 
	  小业态, 
	  NULL, 
	  NULL, 
	  NULL, 
	  SUM(计划套数), 
	  SUM(
		CASE WHEN ISNULL(底价金额, 0) = 0 THEN 楼栋可售面积 / dex ELSE 计划面积 END
	  ) AS 计划面积, 
	  null, 
	  SUM(
		CASE WHEN ISNULL(计划货值, 0) = 0 
		OR ISNULL(底价金额, 0) = 0 THEN 楼栋可售金额 / dex ELSE 计划货值 END
	  ) AS 计划货值, 
	  SUM(动态套数), 
	  SUM(
		CASE WHEN ISNULL(底价金额, 0) = 0 THEN 楼栋可售面积 / dex ELSE 动态面积 END
	  ) AS 动态面积, 
	  null, 
	  SUM(
		CASE WHEN ISNULL(动态货值, 0) = 0 
		OR ISNULL(底价金额, 0) = 0 THEN 楼栋可售金额 / dex ELSE 动态货值 END
	  ) AS 动态货值, 
	  SUM(已取证套数), 
	  SUM(已取证面积), 
	  null AS 已取证均价, 
	  SUM(已取证货值), 
	  SUM(签约套数), 
	  SUM(签约面积), 
	  null AS 签约均价, 
	  SUM(签约货值), 
	  SUM(认购未签套数), 
	  SUM(认购未签面积), 
	  SUM(认购未签货值), 
	  SUM(已推未售套数), 
	  SUM(已推未售面积), 
	  SUM(已推未售货值), 
	  SUM(取证未推售套数), 
	  SUM(取证未推售面积), 
	  SUM(取证未推售货值), 
	  SUM(未取证未推售套数), 
	 -- SUM(未取证未推售面积), 
		   SUM(    CASE WHEN ISNULL(未取证未推售面积, 0) = 0  and  isnull(销许日期,'')=''
	   THEN 楼栋可售面积 / dex ELSE 未取证未推售面积 END ) AS 未取证未推售面积,
	  SUM(    CASE WHEN ISNULL(未取证未推售货值, 0) = 0  and  isnull(销许日期,'')=''
	   THEN 楼栋可售金额 / dex ELSE 未取证未推售货值 END ) AS 未取证未推售货值
	FROM 
	  (
		SELECT 
		  mu.BUName AS 公司, 
		  p1.ProjName AS 项目名称, 
		  p.ProjShortName AS 分期名称, 
		  p.p_projectId AS ProjGUID, 
		  sb.BldGUID AS BldGUID, 
		  pmpt.ParentName AS 大业态, 
		  pmpt.Name AS 小业态, 
		  sb.BldName AS 楼栋名称, 
		  sr.HxName AS 房间户型, 
		  bp.FactEndDate AS 销许日期, 
		  SUM(1) OVER (
			PARTITION BY mu.BUName, p.p_projectId, 
			sb.BldGUID, p1.ProjName, p.ProjShortName, 
			pmpt.ParentName, pmpt.Name, sb.BldName
		  ) AS dex, 
		  AVG(
		  case when mb.IsParkingSpace=1 then
		  mb.TargetUnitPrice*(isnull(mb.UpCarNum,0)+isnull(mb.DownCarNum,0)) else
			mb.TargetUnitPrice * (
			  isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
			) end
		  ) / 10000 AS 楼栋可售金额, 
		  AVG(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) AS 楼栋可售面积, 
		  AVG(mb.TargetUnitPrice) AS 目标单价, 
		  SUM(sr.DjTotal) AS 底价金额, 
		  SUM(
			CASE WHEN isnull(sr.RoomGUID, NULL) IS NOT NULL THEN 1 ELSE 0 END
		  ) AS 计划套数, 
		  CASE WHEN SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) = 0 THEN SUM(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) ELSE SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) END AS 计划面积, 
		  SUM(
			CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END
		  ) / 10000 AS 计划货值, 
		  SUM(
			CASE WHEN isnull(sr.RoomGUID, NULL) IS NOT NULL THEN 1 ELSE 0 END
		  ) AS 动态套数, 
		  CASE WHEN SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) = 0 THEN SUM(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) ELSE SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) END AS 动态面积, 
		  SUM(
			CASE WHEN sr.Status = '签约' and sr.IsAnnexe=0 THEN c.CjRoomTotal 
			WHEN sr.Status = '签约' and sr.IsAnnexe=1 THEN so.CjTotal
			WHEN sr.Status = '认购' and sr.IsAnnexe=0 THEN o.CjRoomTotal 
			WHEN sr.Status = '认购' and sr.IsAnnexe=1 THEN so.CjTotal 
			ELSE CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END END
		  ) / 10000 AS 动态货值, 
		  SUM(
			CASE WHEN isnull(sr.RoomGUID, NULL) IS NOT NULL 
			AND isnull(bp.FactEndDate, '') <> '' THEN 1 ELSE 0 END
		  ) AS 已取证套数, 
		  CASE WHEN isnull(bp.FactEndDate, '') <> '' THEN CASE WHEN SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) = 0 THEN SUM(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) ELSE SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) END ELSE 0 END AS 已取证面积, 
		  CASE WHEN isnull(bp.FactEndDate, '') <> '' THEN SUM(
			CASE WHEN sr.Status = '签约' and sr.IsAnnexe=0 THEN c.CjRoomTotal 
			WHEN sr.Status = '签约' and sr.IsAnnexe=1 THEN so.CjTotal
			WHEN sr.Status = '认购' and sr.IsAnnexe=0 THEN o.CjRoomTotal 
			WHEN sr.Status = '认购' and sr.IsAnnexe=1 THEN so.CjTotal 
			 ELSE CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END END
		  ) / 10000 ELSE 0 END AS 已取证货值, 
		  SUM(
			CASE WHEN sr.Status = '签约' THEN 1 ELSE 0 END
		  ) AS 签约套数, 
		  SUM(
			CASE WHEN sr.Status = '签约' THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 签约面积, 
		  SUM(
			CASE WHEN sr.Status = '签约' and sr.IsAnnexe=0 THEN c.CjRoomTotal
			WHEN sr.Status = '签约' and sr.IsAnnexe=1 THEN so.CjTotal
			 ELSE 0 END
		  ) / 10000 AS 签约货值, 
		  SUM(
			CASE WHEN sr.Status = '认购' THEN 1 ELSE 0 END
		  ) AS 认购未签套数, 
		  SUM(
			CASE WHEN sr.Status = '认购' THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 认购未签面积, 
		  SUM(
			CASE WHEN sr.Status = '认购' and sr.IsAnnexe=0 THEN o.CjRoomTotal 
			WHEN sr.Status = '认购' and sr.IsAnnexe=1 THEN so.CjTotal  ELSE 0 END
		  ) / 10000 AS 认购未签货值, 
		  SUM(
			CASE WHEN sr.Status IN ('待售', '预留', '小订') THEN 1 ELSE 0 END
		  ) AS 已推未售套数, 
		  SUM(
			CASE WHEN sr.Status IN ('待售', '预留', '小订') THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 已推未售面积, 
		  SUM(
			CASE WHEN sr.Status IN ('待售', '预留', '小订') THEN CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END ELSE 0 END
		  ) / 10000 AS 已推未售货值, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') <> '' THEN 1 ELSE 0 END
		  ) AS 取证未推售套数, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') <> '' THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 取证未推售面积, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') <> '' THEN CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END ELSE 0 END
		  ) / 10000 AS 取证未推售货值, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') = '' THEN 1 ELSE 0 END
		  ) AS 未取证未推售套数, 
		  SUM(
				CASE WHEN  isnull(bp.FactEndDate, '') = ''  THEN  sr.BldArea   ELSE 0 END
		  ) AS 未取证未推售面积, 
		  SUM(
			CASE WHEN isnull(bp.FactEndDate, '') = '' THEN CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END ELSE 0 END
		  ) / 10000 AS 未取证未推售货值 
		FROM 
			mdm_Building mb LEFT JOIN 
		  s_Building sb ON sb.MasterBldGUID = mb.BuildingGUID
		 LEFT JOIN s_Room sr ON sb.BldGUID = sr.BldGUID 
		 INNER JOIN (
			SELECT 
			  BuildingGUID, 
			  FactEndDate 
			FROM 
			  p_Build2PlanNode 
			WHERE 
			  NodeName = '获取预售许可证'
		  ) bp ON bp.BuildingGUID = sb.MasterBldGUID  
		  INNER JOIN p_MasterDataProductType pmpt WITH (NOLOCK) ON pmpt.p_MasterDataProductTypeId = sb.ProductTypeGUID 
		  INNER JOIN (
			SELECT 
			  *, 
			  CASE WHEN isnull(ParentCode, '') = '' THEN ProjCode ELSE ParentCode END AS NewParentCode 
			FROM 
			  p_Project
		  ) p ON sb.ProjGUID = p.p_projectId 
		  LEFT JOIN p_project p1 ON p.NewParentCode = p1.ProjCode 
		  INNER JOIN myBusinessUnit mu WITH (NOLOCK) ON mu.BUGUID = mb.BUGUID 
		  AND mu.IsEndCompany = 1 
		  AND mu.BUType = 1 
		  LEFT JOIN s_contract c WITH (NOLOCK) ON sr.RoomGUID = c.RoomGUID 
		  AND c.status = '激活' 
		  LEFT JOIN s_Order o WITH (NOLOCK) ON sr.RoomGUID = o.RoomGUID 
		  AND o.status = '激活' 
		  LEFT JOIN s_OCAttachRoom so ON so.RoomGUID = sr.RoomGUID 
		  AND so.Status = '激活' 
		  where p.p_projectId in (@projguid) and sb.BldGUID in (@bldguid)
		GROUP BY 
		  mu.BUName, 
		  p.p_projectId, 
		  sb.BldGUID, 
		  p1.ProjName, 
		  p.ProjShortName, 
		  pmpt.ParentName, 
		  pmpt.Name, 
		  sb.BldName, 
		  sr.HxName, 
		  bp.FactEndDate
	  ) r 
	GROUP BY 
	  r.公司, 
	  r.项目名称, 
	  大业态, 
	  小业态 
	UNION ALL 
	SELECT 
	  3, 
	  NULL, 
	  NULL, 
	  r.公司, 
	  '所有项目业态汇总', 
	  NULL, 
	  大业态, 
	  小业态, 
	  NULL, 
	  NULL, 
	  NULL, 
	  SUM(计划套数), 
	  SUM(
		CASE WHEN ISNULL(底价金额, 0) = 0 THEN 楼栋可售面积 / dex ELSE 计划面积 END
	  ) AS 计划面积, 
	  null, 
	  SUM(
		CASE WHEN ISNULL(计划货值, 0) = 0 
		OR ISNULL(底价金额, 0) = 0 THEN 楼栋可售金额 / dex ELSE 计划货值 END
	  ) AS 计划货值, 
	  SUM(动态套数), 
	  SUM(
		CASE WHEN ISNULL(底价金额, 0) = 0 THEN 楼栋可售面积 / dex ELSE 动态面积 END
	  ) AS 动态面积, 
	  null, 
	  SUM(
		CASE WHEN ISNULL(动态货值, 0) = 0  and  isnull(销许日期,'')=''
		OR ISNULL(底价金额, 0) = 0 THEN 楼栋可售金额 / dex ELSE 动态货值 END
	  ) AS 动态货值, 
	  SUM(已取证套数), 
	  SUM(已取证面积), 
	  null AS 已取证均价, 
	  SUM(已取证货值), 
	  SUM(签约套数), 
	  SUM(签约面积), 
	  null  AS 签约均价, 
	  SUM(签约货值), 
	  SUM(认购未签套数), 
	  SUM(认购未签面积), 
	  SUM(认购未签货值), 
	  SUM(已推未售套数), 
	  SUM(已推未售面积), 
	  SUM(已推未售货值), 
	  SUM(取证未推售套数), 
	  SUM(取证未推售面积), 
	  SUM(取证未推售货值), 
	  SUM(未取证未推售套数), 
	 -- SUM(未取证未推售面积), 
		  SUM(    CASE WHEN ISNULL(未取证未推售面积, 0) = 0  and  isnull(销许日期,'')=''
	   THEN 楼栋可售面积 / dex ELSE 未取证未推售面积 END ) AS 未取证未推售面积,
	SUM(    CASE WHEN ISNULL(未取证未推售货值, 0) = 0  and  isnull(销许日期,'')=''
	   THEN 楼栋可售金额 / dex ELSE 未取证未推售货值 END ) AS 未取证未推售货值
	FROM 
	  (
		 SELECT 
		  mu.BUName AS 公司, 
		  p1.ProjName AS 项目名称, 
		  p.ProjShortName AS 分期名称, 
		  p.p_projectId AS ProjGUID, 
		  sb.BldGUID AS BldGUID, 
		  pmpt.ParentName AS 大业态, 
		  pmpt.Name AS 小业态, 
		  sb.BldName AS 楼栋名称, 
		  sr.HxName AS 房间户型, 
		  bp.FactEndDate AS 销许日期, 
		  SUM(1) OVER (
			PARTITION BY mu.BUName, p.p_projectId, 
			sb.BldGUID, p1.ProjName, p.ProjShortName, 
			pmpt.ParentName, pmpt.Name, sb.BldName
		  ) AS dex, 
		  AVG(
		  case when mb.IsParkingSpace=1 then
		  mb.TargetUnitPrice*(isnull(mb.UpCarNum,0)+isnull(mb.DownCarNum,0)) else
			mb.TargetUnitPrice * (
			  isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
			) end
		  ) / 10000 AS 楼栋可售金额, 
		  AVG(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) AS 楼栋可售面积, 
		  AVG(mb.TargetUnitPrice) AS 目标单价, 
		  SUM(sr.DjTotal) AS 底价金额, 
		  SUM(
			CASE WHEN isnull(sr.RoomGUID, NULL) IS NOT NULL THEN 1 ELSE 0 END
		  ) AS 计划套数, 
		  CASE WHEN SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) = 0 THEN SUM(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) ELSE SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) END AS 计划面积, 
		  SUM(
			CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END
		  ) / 10000 AS 计划货值, 
		  SUM(
			CASE WHEN isnull(sr.RoomGUID, NULL) IS NOT NULL THEN 1 ELSE 0 END
		  ) AS 动态套数, 
		  CASE WHEN SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) = 0 THEN SUM(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) ELSE SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) END AS 动态面积, 
		  SUM(
			CASE WHEN sr.Status = '签约' and sr.IsAnnexe=0 THEN c.CjRoomTotal 
			WHEN sr.Status = '签约' and sr.IsAnnexe=1 THEN so.CjTotal
			WHEN sr.Status = '认购' and sr.IsAnnexe=0 THEN o.CjRoomTotal 
			WHEN sr.Status = '认购' and sr.IsAnnexe=1 THEN so.CjTotal 
			ELSE CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END END
		  ) / 10000 AS 动态货值, 
		  SUM(
			CASE WHEN isnull(sr.RoomGUID, NULL) IS NOT NULL 
			AND isnull(bp.FactEndDate, '') <> '' THEN 1 ELSE 0 END
		  ) AS 已取证套数, 
		  CASE WHEN isnull(bp.FactEndDate, '') <> '' THEN CASE WHEN SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) = 0 THEN SUM(
			isnull(mb.UpSaleArea, 0.00) + isnull(mb.DownSaleArea, 0.00)
		  ) ELSE SUM(
			CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END
		  ) END ELSE 0 END AS 已取证面积, 
		  CASE WHEN isnull(bp.FactEndDate, '') <> '' THEN SUM(
			CASE WHEN sr.Status = '签约' and sr.IsAnnexe=0 THEN c.CjRoomTotal 
			WHEN sr.Status = '签约' and sr.IsAnnexe=1 THEN so.CjTotal
			WHEN sr.Status = '认购' and sr.IsAnnexe=0 THEN o.CjRoomTotal 
			WHEN sr.Status = '认购' and sr.IsAnnexe=1 THEN so.CjTotal 
			 ELSE CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END END
		  ) / 10000 ELSE 0 END AS 已取证货值, 
		  SUM(
			CASE WHEN sr.Status = '签约' THEN 1 ELSE 0 END
		  ) AS 签约套数, 
		  SUM(
			CASE WHEN sr.Status = '签约' THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 签约面积, 
		  SUM(
			CASE WHEN sr.Status = '签约' and sr.IsAnnexe=0 THEN c.CjRoomTotal
			WHEN sr.Status = '签约' and sr.IsAnnexe=1 THEN so.CjTotal
			 ELSE 0 END
		  ) / 10000 AS 签约货值, 
		  SUM(
			CASE WHEN sr.Status = '认购' THEN 1 ELSE 0 END
		  ) AS 认购未签套数, 
		  SUM(
			CASE WHEN sr.Status = '认购' THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 认购未签面积, 
		  SUM(
			CASE WHEN sr.Status = '认购' and sr.IsAnnexe=0 THEN o.CjRoomTotal 
			WHEN sr.Status = '认购' and sr.IsAnnexe=1 THEN so.CjTotal  ELSE 0 END
		  ) / 10000 AS 认购未签货值, 
		  SUM(
			CASE WHEN sr.Status IN ('待售', '预留', '小订') THEN 1 ELSE 0 END
		  ) AS 已推未售套数, 
		  SUM(
			CASE WHEN sr.Status IN ('待售', '预留', '小订') THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 已推未售面积, 
		  SUM(
			CASE WHEN sr.Status IN ('待售', '预留', '小订') THEN CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END ELSE 0 END
		  ) / 10000 AS 已推未售货值, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') <> '' THEN 1 ELSE 0 END
		  ) AS 取证未推售套数, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') <> '' THEN CASE WHEN isnull(sr.ScBldArea, 0) <> 0 THEN sr.ScBldArea ELSE sr.BldArea END ELSE 0 END
		  ) AS 取证未推售面积, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') <> '' THEN CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END ELSE 0 END
		  ) / 10000 AS 取证未推售货值, 
		  SUM(
			CASE WHEN sr.Status = '销控' 
			AND isnull(bp.FactEndDate, '') = '' THEN 1 ELSE 0 END
		  ) AS 未取证未推售套数, 
		  SUM(
				CASE WHEN  isnull(bp.FactEndDate, '') = ''  THEN  sr.BldArea   ELSE 0 END
		  ) AS 未取证未推售面积, 
		  SUM(
			CASE WHEN isnull(bp.FactEndDate, '') = '' THEN CASE WHEN isnull(sr.DjTotal, 0) <> 0 THEN sr.DjTotal ELSE isnull(mb.targetUnitPrice, 0) * sr.BldArea END ELSE 0 END
		  ) / 10000 AS 未取证未推售货值 
		FROM 
		   mdm_Building mb LEFT JOIN 
		  s_Building sb ON sb.MasterBldGUID = mb.BuildingGUID
		 LEFT JOIN s_Room sr ON sb.BldGUID = sr.BldGUID 
		 INNER JOIN (
			SELECT 
			  BuildingGUID, 
			  FactEndDate 
			FROM 
			  p_Build2PlanNode 
			WHERE 
			  NodeName = '获取预售许可证'
		  ) bp ON bp.BuildingGUID = sb.MasterBldGUID  
		  INNER JOIN p_MasterDataProductType pmpt WITH (NOLOCK) ON pmpt.p_MasterDataProductTypeId = sb.ProductTypeGUID 
		  INNER JOIN (
			SELECT 
			  *, 
			  CASE WHEN isnull(ParentCode, '') = '' THEN ProjCode ELSE ParentCode END AS NewParentCode 
			FROM 
			  p_Project
		  ) p ON sb.ProjGUID = p.p_projectId 
		  LEFT JOIN p_project p1 ON p.NewParentCode = p1.ProjCode 
		  INNER JOIN myBusinessUnit mu WITH (NOLOCK) ON mu.BUGUID = mb.BUGUID 
		  AND mu.IsEndCompany = 1 
		  AND mu.BUType = 1 
		  LEFT JOIN s_contract c WITH (NOLOCK) ON sr.RoomGUID = c.RoomGUID 
		  AND c.status = '激活' 
		  LEFT JOIN s_Order o WITH (NOLOCK) ON sr.RoomGUID = o.RoomGUID 
		  AND o.status = '激活' 
		  LEFT JOIN s_OCAttachRoom so ON so.RoomGUID = sr.RoomGUID 
		  AND so.Status = '激活' 
		 where p.p_projectId in (@projguid) and sb.BldGUID in (@bldguid)
		GROUP BY 
		  mu.BUName, 
		  p.p_projectId, 
		  sb.BldGUID, 
		  p1.ProjName, 
		  p.ProjShortName, 
		  pmpt.ParentName, 
		  pmpt.Name, 
		  sb.BldName, 
		  sr.HxName, 
		  bp.FactEndDate
	  ) r 
	GROUP BY 
	  r.公司, 
	  大业态, 
	  小业态
  ) hz

衣服 1500+
  口红+眼影等化妆品 2000+
  AirPods 1000
  MacBook 2500



整体的感觉还是比较好的
优点：
1.技术能力和理解能力都不错，已经具备独立写报表的能力。
2.有较强学习适应及转化能力，遇到的坑都能及时调整并做出总结。
缺点：
1.对于一些细节上比较粗心，做事略微有点浮躁；
2.主观意识太强，对于出现的问题不主动沟通按自己的思路做好后才发现问题，容易跑偏做无用功；
3.对于问题的对接沟通缺乏主动性，对于报表口径问题不喜欢主动问需求提出人员。



